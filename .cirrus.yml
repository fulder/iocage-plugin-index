freebsd_instance:
  image_family: freebsd-12-2
  cpu: 1
  memory: 256M

install_backuppc_task:
  install_script: pkg install -y jq
  test_script: |
    plugin_file=backuppc.json
    release=$(jq -r '.release' $plugin_file)
    name=$(jq '.name' $plugin_file)
    packagesite=$(jq '.packagesite' $plugin_file)
    fingerprints=$(jq -r '.fingerprints | keys[]' backuppc.json)

    echo "Parsed plugin info"
    echo "Release: $release"
    echo "Name: $name"
    echo "Packagesite: $packagesite"
    echo "Fingerprints: $fingerprints"

    major_freebsd_release=$(freebsd-version | cut -d "." -f1)
    export ABI="FreeBSD:${major_freebsd_release}:amd64"
    echo "Setting PACKAGESITE env var to: ${packagesite}"
    export PACKAGESITE=${packagesite}
    export SIGNATURE_TYPE=FINGERPRINTS
    export FINGERPRINTS=/usr/local/etc/pkg/fingerprints

    for repo_name in $fingerprints
    do
      repo_path="${FINGERPRINTS}/$repo_name/trusted"
      mkdir -p ${repo_path}
      repos=$(jq '."fingerprints"."'${repo_name}'"' $plugin_file)

      repo_count=1
      for r in $repos
      do
        function=$(echo $r | jq -r '.function')
        fingerprint=$(echo $r | jq -r '.fingerprint')
        file_path=${repo_path}/${repo_name}_${repo_count}

        echo "Creating new fingerprint file: ${file_path}"

        echo "function: $function" > ${file_path}
        echo "fingerprint: $fingerprint" >> ${file_path}

        repo_count=$(expr $repo_count + 1)
      done
    done

    echo "Testing install plugin pkgs for plugin: $name"
    pkgs=$(jq -r '.pkgs[]' $plugin_file)
    echo "Installing $name pkgs: $pkgs"
    pkg install -y $pkgs
