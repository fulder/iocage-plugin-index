name: Test installing plugins

on: [push]

jobs:
  test-install:
    runs-on: macos-latest
    name: Test install updated plugins

    steps:
      - uses: actions/checkout@v2

      - name: get changed plugin files
        id: changed_plugins
        run: |
          plugin_files=$(git diff origin/master... --name-only | grep .json)
          echo $plugin_files
          echo "::set-output name=files::${plugin_files}"

      - name: Test in FreeBSD
        id: test
        uses: vmactions/freebsd-vm@v0.1.2
        with:
          usesh: true
          prepare: |
            pkg update
            pkg install -y jq
          run: |
            ls -l
            freebsd-version

            for i in ${{ steps.changed_plugins.outputs.files }}
            do
                release=$(jq '.release' $i)
                if [[ $a == "12.2"* ]]
                then
                  echo "Testing install plugin pkgs from $i"

                  pkgs=$(jq '.pkgs[]' $i)
                  echo "$i pkgs: $pkgs"
                  pkg install -y $pkgs
                fi
            done

